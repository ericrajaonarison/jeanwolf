<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Projektverwaltung</title>
  <style>
    body { 
      background: #b0b0b0; 
      font-family: monospace; 
      margin: 0; 
      padding: 20px; 
    }
    
    .breadcrumb { 
      position: fixed; 
      top: 10px; 
      left: 10px; 
      display: flex; 
      gap: 5px; 
      z-index: 1001; 
    }
    
    .breadcrumb-item { 
      cursor: pointer; 
      color: black; 
      padding: 0 5px; 
    }
    
    .breadcrumb-item:hover { 
      color: blue; 
    }
    
    #folderView, #pinView, #imageView { 
      display: none; 
    }
    
    #folderView { 
      margin-top: 40px; 
    }
    
    .folder { 
      display: inline-block; 
      text-align: center; 
      margin: 15px; 
      position: relative; 
    }
    
    .folder-icon { 
      width: 60px; 
      height: 40px; 
      background: black; 
      position: relative; 
      cursor: pointer; 
    }
    
    .folder-icon::before { 
      content: ""; 
      position: absolute; 
      top: -8px; 
      left: 0; 
      width: 20px; 
      height: 8px; 
      background: black; 
    }
    
    .folder-name { 
      margin-top: 5px; 
      color: black; 
    }
    
    .folder-delete { 
      position: absolute; 
      top: -15px; 
      right: -15px; 
      color: black; 
      display: none; 
      cursor: pointer; 
      font-size: 20px;
    }
    
    .edit-mode .folder-delete { 
      display: block; 
    }
    
    button { 
      background: none; 
      border: none; 
      padding: 10px 15px;
      cursor: pointer; 
      font-size: 16px;
    }
    
    #headerButtons { 
      position: fixed; 
      top: 10px; 
      right: 10px; 
      display: flex; 
      gap: 15px; 
    }
    
    .image-gallery { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 10px; 
      margin-top: 60px; 
    }
    
    .thumbnail-container { 
      width: 400px;
      height: 400px;
      position: relative; 
    }
    
    .thumbnail { 
      width: 100%; 
      height: 100%; 
      object-fit: contain; 
      cursor: pointer; 
    }
    
    .delete-image { 
      position: absolute; 
      top: 5px; 
      right: 5px; 
      color: black; 
      display: none; 
      cursor: pointer; 
      font-size: 20px;
      z-index: 100;
    }
    
    .favorite-btn { 
      position: absolute; 
      bottom: 10px; 
      left: 10px; 
      transform: none;
      background: none;
      border: none;
      cursor: pointer;
      width: 24px;
      height: 24px;
      padding: 0;
      display: none;
    }
    
    .favorite-btn.active { 
      display: block; 
    }
    
    .favorite-btn:before { 
      content: ""; 
      display: block; 
      width: 20px; 
      height: 20px; 
      border: 2px solid #ff69b4; 
      border-radius: 50%;
    }
    
    .favorite-btn.active:before { 
      background: #ff69b4; 
    }
    
    .edit-mode .delete-image { 
      display: block; 
    }
    
    #overlay { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: #b0b0b0; 
      display: none; 
      flex-direction: column;
      justify-content: center; 
      align-items: center; 
      z-index: 1000; 
    }
    
    .image-container {
      position: relative;
      max-width: 90%;
      max-height: 70%;
      text-align: center;
    }
    
    #fullImage { 
      max-width: 100%; 
      max-height: 70vh; 
      object-fit: contain; 
    }
    
    /* Overlay Controls: Next, Back und Lieblings-Button auf gleicher Höhe */
    .overlay-controls { 
      position: absolute; 
      bottom: 10px; 
      left: 0; 
      right: 0; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      width: 90%; 
      max-width: 90%; 
      margin: 0 auto;
      padding: 0 20px;
      box-sizing: border-box;
    }
    
    .nav-arrow { 
      background: none; 
      border: none; 
      cursor: pointer; 
      font-size: 16px; 
      padding: 5px 10px;
    }
    
    .nav-arrow:hover { 
      color: blue; 
    }
    
    #favoriteOverlayBtn {
      width: 24px;
      height: 24px;
      background: none;
      border: none;
      cursor: pointer;
      position: relative;
    }
    
    #favoriteOverlayBtn:before {
      content: "";
      display: block;
      width: 20px;
      height: 20px;
      border: 2px solid #ff69b4;
      border-radius: 50%;
    }
    
    #favoriteOverlayBtn.active:before {
      background: #ff69b4;
    }
    
    #pinView {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1003;
    }
    
    #pinInput {
      border: 2px solid black;
      padding: 8px;
      margin-right: 10px;
    }

    #downloadFavorites {
      border: none !important;
      color: #ff69b4;
      padding: 5px 10px;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
</head>
<body>
  <div class="breadcrumb"></div>
  <div id="headerButtons">
    <button id="editButton">Edit</button>
    <button id="downloadFavorites" style="display:none">↓ Favoriten</button>
    <button id="addProject" style="display:none">+ Neuer Ordner</button>
    <button id="uploadButton" style="display:none">↑ Hochladen</button>
  </div>

  <div id="folderView">
    <div id="foldersContainer"></div>
  </div>

  <div id="pinView" style="display:none;">
    <input type="password" id="pinInput" placeholder="PIN">
    <button id="submitPin">OK</button>
    <button id="cancelPin">Abbrechen</button>
  </div>

  <div id="imageView">
    <div class="image-gallery"></div>
    <input type="file" id="imageUpload" multiple accept="image/*" style="display:none">
  </div>

  <div id="overlay">
    <div class="image-container">
      <img id="fullImage">
    </div>
    <div class="overlay-controls">
      <button id="prevBtn" class="nav-arrow">BACK</button>
      <button id="favoriteOverlayBtn"></button>
      <button id="nextBtn" class="nav-arrow">NEXT</button>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAa0f8TC095yg8so6bgQFIWbJ4n4Z4AFDA",
      authDomain: "jeanwolf.firebaseapp.com",
      projectId: "jeanwolf",
      storageBucket: "jeanwolf.firebasestorage.app",
      messagingSenderId: "615121748216",
      appId: "1:615121748216:web:d60808a70e5e869b743b0d",
      measurementId: "G-HNP0ZS7VDW"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    let editMode = false;
    let currentPath = [];
    let currentFolderId = null;
    let currentImageIndex = 0;
    let currentImages = [];
    let favorites = [];
    let currentPendingFolder = null;
    let unsubscribeFolders = null;

    function initFirestoreListener() {
      if (unsubscribeFolders) unsubscribeFolders();
      const parentId = currentPath.length > 0 
        ? currentPath[currentPath.length - 1].id 
        : null;
      unsubscribeFolders = db.collection('projects')
        .where('parentId', '==', parentId)
        .orderBy('createdAt')
        .onSnapshot(snapshot => {
          renderFolders(snapshot.docs);
          if (currentFolderId) renderImageGallery();
        }, error => console.error('Listener error:', error));
    }

    async function renderFolders(docs) {
      const container = document.getElementById('foldersContainer');
      container.innerHTML = '';
      docs.forEach(doc => {
        const project = doc.data();
        const folder = document.createElement('div');
        folder.className = 'folder';
        folder.innerHTML = `
          <div class="folder-icon"></div>
          <div class="folder-name">${project.name}</div>
          <div class="folder-delete">×</div>
        `;
        folder.querySelector('.folder-icon').addEventListener('click', async () => {
          const docSnap = await db.collection('projects').doc(doc.id).get();
          const data = docSnap.data();
          if (data.pin) {
            currentPendingFolder = doc.id;
            document.getElementById('pinView').style.display = 'block';
          } else {
            currentPath.push({ id: doc.id, name: project.name });
            currentFolderId = doc.id;
            updateBreadcrumb();
            initFirestoreListener();
            showImageView();
          }
        });
        folder.querySelector('.folder-delete').addEventListener('click', async e => {
          e.stopPropagation();
          if (confirm('Ordner und alle Unterordner sowie Bilder löschen?')) {
            await deleteFolder(doc.id);
            initFirestoreListener();
          }
        });
        container.appendChild(folder);
      });
    }

    async function deleteFolder(folderId) {
      const subfolders = await db.collection('projects').where('parentId', '==', folderId).get();
      await Promise.all(subfolders.docs.map(doc => deleteFolder(doc.id)));
      const docRef = db.collection('projects').doc(folderId);
      const doc = await docRef.get();
      const images = doc.data().images || [];
      await Promise.all(images.map(url => 
        storage.refFromURL(url).delete().catch(console.error)
      ));
      await docRef.delete();
    }

    async function checkPin() {
      const doc = await db.collection('projects').doc(currentPendingFolder).get();
      return doc.data().pin === document.getElementById('pinInput').value;
    }

    document.getElementById('submitPin').addEventListener('click', async () => {
      if (await checkPin()) {
        const doc = await db.collection('projects').doc(currentPendingFolder).get();
        currentPath.push({ id: currentPendingFolder, name: doc.data().name });
        currentFolderId = currentPendingFolder;
        updateBreadcrumb();
        initFirestoreListener();
        showImageView();
        document.getElementById('pinView').style.display = 'none';
      } else {
        alert('Falscher PIN!');
      }
    });

    document.getElementById('cancelPin').addEventListener('click', () => {
      document.getElementById('pinView').style.display = 'none';
    });

    function updateBreadcrumb() {
      const bc = document.querySelector('.breadcrumb');
      bc.innerHTML = currentPath.reduce((acc, cur, i) => 
        acc + `<div class="breadcrumb-item" data-index="${i}">${cur.name}</div> / `, 
        '<div class="breadcrumb-item" data-index="-1">Jean Wolf</div> / '
      );
      document.querySelectorAll('.breadcrumb-item').forEach(item => {
        item.addEventListener('click', () => {
          const idx = parseInt(item.dataset.index);
          if (idx === -1) {
            currentPath = [];
            currentFolderId = null;
          } else {
            currentPath = currentPath.slice(0, idx+1);
            currentFolderId = currentPath[idx].id;
          }
          updateBreadcrumb();
          initFirestoreListener();
          showFolderView();
        });
      });
    }

    async function renderImageGallery() {
      const gallery = document.querySelector('.image-gallery');
      gallery.innerHTML = '';
      if (!currentFolderId) return;
      const doc = await db.collection('projects').doc(currentFolderId).get();
      currentImages = doc.exists ? doc.data().images || [] : [];
      favorites = doc.data().favorites || [];
      document.getElementById('downloadFavorites').style.display = favorites.length>0 ? 'block' : 'none';
      currentImages.forEach((url, idx) => {
        const container = document.createElement('div');
        container.className = 'thumbnail-container';
        container.innerHTML = `
          <img src="${url}" class="thumbnail">
          <div class="delete-image" data-index="${idx}">×</div>
          <button class="favorite-btn ${favorites.includes(url)?'active':''}"></button>
        `;
        container.querySelector('.thumbnail').addEventListener('click', ()=>{
          currentImageIndex = idx;
          showOverlay();
        });
        container.querySelector('.delete-image').addEventListener('click',async e=>{
          e.stopPropagation();
          await deleteImage(idx);
        });
        container.querySelector('.favorite-btn').addEventListener('click',async e=>{
          e.stopPropagation();
          await toggleFavorite(url);
        });
        gallery.appendChild(container);
      });
    }

    async function toggleFavorite(url) {
      const docRef = db.collection('projects').doc(currentFolderId);
      if (favorites.includes(url)) {
        favorites = favorites.filter(u=>u!==url);
      } else {
        favorites.push(url);
      }
      await docRef.update({ favorites });
      renderImageGallery();
    }

    function showOverlay() {
      const overlay = document.getElementById('overlay');
      const fullImage = document.getElementById('fullImage');
      const favBtn = document.getElementById('favoriteOverlayBtn');
      fullImage.src = currentImages[currentImageIndex];
      favBtn.classList.toggle('active', favorites.includes(fullImage.src));
      overlay.style.display = 'flex';

      document.getElementById('prevBtn').onclick = () => {
        currentImageIndex = (currentImageIndex - 1 + currentImages.length) % currentImages.length;
        fullImage.src = currentImages[currentImageIndex];
        favBtn.classList.toggle('active', favorites.includes(fullImage.src));
      };
      document.getElementById('nextBtn').onclick = () => {
        currentImageIndex = (currentImageIndex + 1) % currentImages.length;
        fullImage.src = currentImages[currentImageIndex];
        favBtn.classList.toggle('active', favorites.includes(fullImage.src));
      };
      favBtn.onclick = async () => {
        await toggleFavorite(fullImage.src);
        favBtn.classList.toggle('active', favorites.includes(fullImage.src));
      };
      overlay.onclick = e => {
        if (e.target === overlay) overlay.style.display = 'none';
      };
    }

    async function deleteImage(idx) {
      const docRef = db.collection('projects').doc(currentFolderId);
      const doc = await docRef.get();
      let imgs = [...doc.data().images];
      const [url] = imgs.splice(idx,1);
      await storage.refFromURL(url).delete();
      await docRef.update({ images: imgs });
      renderImageGallery();
    }

    document.getElementById('uploadButton').addEventListener('click', () => {
      document.getElementById('imageUpload').click();
    });
    document.getElementById('imageUpload').addEventListener('change', async function(e) {
      if (!currentFolderId) { alert('Bitte Ordner auswählen!'); return; }
      const files = Array.from(this.files);
      for (const file of files) {
        const safeName = file.name.replace(/[^a-z0-9_.-]/gi,'_');
        try {
          const ref = storage.ref(`projects/${currentFolderId}/${Date.now()}_${safeName}`);
          await ref.put(file);
          const url = await ref.getDownloadURL();
          await db.collection('projects').doc(currentFolderId)
            .update({ images: firebase.firestore.FieldValue.arrayUnion(url) });
        } catch(err) {
          console.error(err);
          alert(`Fehler bei ${file.name}: ${err.message}`);
        }
      }
      this.value = '';
      renderImageGallery();
    });

    document.getElementById('editButton').addEventListener('click', () => {
      editMode = !editMode;
      document.body.classList.toggle('edit-mode', editMode);
      document.getElementById('editButton').textContent = editMode ? 'Speichern' : 'Edit';
      document.getElementById('addProject').style.display = editMode ? 'block':'none';
      document.getElementById('uploadButton').style.display = editMode ? 'block':'none';
    });
    document.getElementById('addProject').addEventListener('click', async () => {
      const name = prompt('Ordnername:');
      const pin = prompt('PIN (optional):');
      if (!name) return;
      try {
        await db.collection('projects').add({
          name: name.trim(),
          pin: pin||null,
          parentId: currentFolderId,
          images: [],
          favorites: [],
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastModified: firebase.firestore.FieldValue.serverTimestamp()
        });
        initFirestoreListener();
      } catch(err){ alert('Fehler: '+err.message); }
    });

    async function downloadAllFavorites() {
      if (!favorites.length) { alert('Keine favorisierten Bilder vorhanden!'); return; }
      const zip = new JSZip().folder('favorites');
      try {
        await Promise.all(favorites.map(async (url,i) => {
          const res = await fetch(url);
          if (!res.ok) throw new Error(res.statusText);
          const blob = await res.blob();
          const name = url.split('/').pop().split('?')[0];
          zip.file(name, blob);
        }));
        const content = await zip.generateAsync({type:'blob'});
        saveAs(content,'favorites.zip');
      } catch(err){
        console.error(err);
        alert('Fehler beim Erstellen des ZIP-Archivs!');
      }
    }
    document.getElementById('downloadFavorites').addEventListener('click', downloadAllFavorites);

    function showFolderView() {
      document.getElementById('folderView').style.display = 'block';
      document.getElementById('imageView').style.display = 'none';
      document.getElementById('downloadFavorites').style.display = 'none';
      initFirestoreListener();
    }
    function showImageView() {
      document.getElementById('folderView').style.display = 'none';
      document.getElementById('imageView').style.display = 'block';
      document.getElementById('downloadFavorites').style.display =
        favorites.length>0 ? 'block':'none';
    }

    updateBreadcrumb();
    initFirestoreListener();
    showFolderView();
  </script>
</body>
</html>
