<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Projektverwaltung</title>
  <style>
    body { 
      background: #b0b0b0; 
      font-family: monospace; 
      margin: 0; 
      padding: 20px; 
    }
    
    .breadcrumb { 
      position: fixed; 
      top: 10px; 
      left: 10px; 
      display: flex; 
      gap: 5px; 
      z-index: 1001; 
    }
    
    .breadcrumb-item { 
      cursor: pointer; 
      color: black; 
      padding: 0 5px; 
    }
    
    .breadcrumb-item:hover { 
      color: blue; 
    }
    
    #folderView, #pinView, #imageView { 
      display: none; 
    }
    
    #folderView { 
      margin-top: 40px; 
    }
    
    .folder { 
      display: inline-block; 
      text-align: center; 
      margin: 15px; 
      position: relative; 
    }
    
    .folder-icon { 
      width: 60px; 
      height: 40px; 
      background: black; 
      position: relative; 
      cursor: pointer; 
    }
    
    .folder-icon::before { 
      content: ""; 
      position: absolute; 
      top: -8px; 
      left: 0; 
      width: 20px; 
      height: 8px; 
      background: black; 
    }
    
    .folder-name { 
      margin-top: 5px; 
      color: black; 
    }
    
    .folder-delete { 
      position: absolute; 
      top: -15px; 
      right: -15px; 
      color: black; 
      display: none; 
      cursor: pointer; 
      font-size: 20px;
    }
    
    .edit-mode .folder-delete { 
      display: block; 
    }
    
    button { 
      background: none; 
      border: none; 
      padding: 10px 15px;
      cursor: pointer; 
      font-size: 16px;
    }
    
    #headerButtons { 
      position: fixed; 
      top: 10px; 
      right: 10px; 
      display: flex; 
      gap: 15px; 
    }
    
    .image-gallery { 
      display: block;
      margin-top: 60px;
      padding: 20px;
    }
    
    .thumbnail-container { 
      width: 100%;
      max-width: 1000px;
      margin: 0 auto 40px;
      position: relative;
    }
    
    .thumbnail { 
      width: 100%;
      height: auto;
      max-height: 80vh;
      object-fit: contain;
    }
    
    .delete-image { 
      position: absolute; 
      top: 5px; 
      right: 5px; 
      color: black; 
      display: none; 
      cursor: pointer; 
      font-size: 20px;
      z-index: 100;
    }
    
    .favorite-btn { 
      position: absolute;
      bottom: -25px;
      left: 10px;
      color: black;
      font-weight: bold;
      background: none;
      border: none;
      cursor: pointer;
      padding: 2px 5px;
      font-size: 14px;
    }
    
    .favorite-btn.active { 
      color: #ff69b4;
    }
    
    .edit-mode .delete-image { 
      display: block; 
    }
    
    #pinView {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1003;
    }
    
    #pinInput {
      border: 2px solid black;
      padding: 8px;
      margin-right: 10px;
    }

    #downloadFavorites {
      border: none !important;
      color: #ff69b4;
      padding: 5px 10px;
    }

    @media (max-width: 768px) {
      .thumbnail-container {
        max-width: 95%;
      }
    }

    /* Verstecke nur den Edit-Button (sichtbar bleibt seine Funktion) */
    #editButton {
      display: none !important;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
</head>
<body>
  <div class="breadcrumb"></div>
  <div id="headerButtons">
    <button id="editButton">Edit</button>
    <button id="downloadFavorites" style="display:none">↓ Favoriten</button>
    <button id="addProject" style="display:none">+ Neuer Ordner</button>
    <button id="uploadButton" style="display:none">↑ Hochladen</button>
  </div>

  <div id="folderView">
    <div id="foldersContainer"></div>
  </div>

  <div id="pinView" style="display:none;">
    <input type="password" id="pinInput" placeholder="PIN">
    <button id="submitPin">OK</button>
    <button id="cancelPin">Abbrechen</button>
  </div>

  <div id="imageView">
    <div class="image-gallery"></div>
    <input type="file" id="imageUpload" multiple accept="image/*" style="display:none">
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAa0f8TC095yg8so6bgQFIWbJ4n4Z4AFDA",
      authDomain: "jeanwolf.firebaseapp.com",
      projectId: "jeanwolf",
      storageBucket: "jeanwolf.firebasestorage.app",
      messagingSenderId: "615121748216",
      appId: "1:615121748216:web:d60808a70e5e869b743b0d",
      measurementId: "G-HNP0ZS7VDW"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    let editMode = false;
    let currentPath = [];
    let currentFolderId = null;
    let currentImages = [];
    let favorites = [];
    let currentPendingFolder = null;
    let unsubscribeFolders = null;

    function initFirestoreListener() {
      if (unsubscribeFolders) unsubscribeFolders();
      const parentId = currentPath.length ? currentPath[currentPath.length - 1].id : null;
      unsubscribeFolders = db.collection('projects')
        .where('parentId', '==', parentId)
        .orderBy('createdAt')
        .onSnapshot(snapshot => {
          renderFolders(snapshot.docs);
          if (currentFolderId) renderImageGallery();
        }, console.error);
    }

    async function renderFolders(docs) {
      const container = document.getElementById('foldersContainer');
      container.innerHTML = '';
      docs.forEach(doc => {
        const p = doc.data();
        const folder = document.createElement('div');
        folder.className = 'folder';
        folder.innerHTML = `
          <div class="folder-icon"></div>
          <div class="folder-name">${p.name}</div>
          <div class="folder-delete">×</div>
        `;
        folder.querySelector('.folder-icon').addEventListener('click', async () => {
          const snap = await db.collection('projects').doc(doc.id).get();
          if (snap.data().pin) {
            currentPendingFolder = doc.id;
            document.getElementById('pinView').style.display = 'block';
          } else {
            currentPath.push({ id: doc.id, name: p.name });
            currentFolderId = doc.id;
            updateBreadcrumb();
            initFirestoreListener();
            showImageView();
          }
        });
        folder.querySelector('.folder-delete').addEventListener('click', async e => {
          e.stopPropagation();
          if (confirm('Ordner und alle Unterordner sowie Bilder löschen?')) {
            await deleteFolder(doc.id);
            initFirestoreListener();
          }
        });
        container.appendChild(folder);
      });
    }

    async function deleteFolder(id) {
      const subs = await db.collection('projects').where('parentId', '==', id).get();
      await Promise.all(subs.docs.map(d => deleteFolder(d.id)));
      const ref = db.collection('projects').doc(id);
      const data = (await ref.get()).data();
      const imgs = data.images || [];
      await Promise.all(imgs.map(u => storage.refFromURL(u).delete().catch(console.error)));
      await ref.delete();
    }

    async function checkPin() {
      const d = (await db.collection('projects').doc(currentPendingFolder).get()).data();
      return d.pin === document.getElementById('pinInput').value;
    }

    document.getElementById('submitPin').addEventListener('click', async () => {
      if (await checkPin()) {
        const snap = await db.collection('projects').doc(currentPendingFolder).get();
        currentPath.push({ id: currentPendingFolder, name: snap.data().name });
        currentFolderId = currentPendingFolder;
        updateBreadcrumb();
        initFirestoreListener();
        showImageView();
        document.getElementById('pinView').style.display = 'none';
      } else alert('Falscher PIN!');
    });

    document.getElementById('cancelPin').addEventListener('click', () => {
      document.getElementById('pinView').style.display = 'none';
    });

    function updateBreadcrumb() {
      const bc = document.querySelector('.breadcrumb');
      bc.innerHTML = currentPath.reduce((acc, cur, i) =>
        acc + `<div class="breadcrumb-item" data-index="${i}">${cur.name}</div> / `,
        '<div class="breadcrumb-item" data-index="-1">Jean Wolf</div> / '
      );
      bc.querySelectorAll('.breadcrumb-item').forEach(item => {
        item.addEventListener('click', () => {
          const i = +item.dataset.index;
          if (i < 0) currentPath = [], currentFolderId = null;
          else {
            currentPath = currentPath.slice(0, i+1);
            currentFolderId = currentPath[i].id;
          }
          updateBreadcrumb();
          initFirestoreListener();
          showFolderView();
        });
      });
    }

    async function renderImageGallery() {
      const gal = document.querySelector('.image-gallery');
      gal.innerHTML = '';
      if (!currentFolderId) return;
      const snap = await db.collection('projects').doc(currentFolderId).get();
      currentImages = snap.data().images || [];
      favorites = snap.data().favorites || [];
      document.getElementById('downloadFavorites').style.display =
        favorites.length ? 'block' : 'none';

      currentImages.forEach((url, idx) => {
        const cont = document.createElement('div');
        cont.className = 'thumbnail-container';
        cont.innerHTML = `
          <img src="${url}" class="thumbnail">
          <div class="delete-image" data-index="${idx}">×</div>
          <button class="favorite-btn ${favorites.includes(url)?'active':''}">FAV</button>
        `;
        cont.querySelector('.favorite-btn').addEventListener('click', async e => {
          e.stopPropagation();
          await toggleFavorite(url, e.currentTarget);
        });
        cont.querySelector('.delete-image').addEventListener('click', async e => {
          e.stopPropagation();
          await deleteImage(idx);
        });
        gal.appendChild(cont);
      });
    }

    async function toggleFavorite(url, btn) {
      const ref = db.collection('projects').doc(currentFolderId);
      const isFav = favorites.includes(url);
      favorites = isFav
        ? favorites.filter(u => u !== url)
        : [...favorites, url];
      btn.classList.toggle('active', !isFav);
      await ref.update({ favorites });
      document.getElementById('downloadFavorites').style.display =
        favorites.length ? 'block' : 'none';
    }

    async function deleteImage(idx) {
      const ref = db.collection('projects').doc(currentFolderId);
      const snap = await ref.get();
      const imgs = [...snap.data().images];
      const [url] = imgs.splice(idx,1);
      await storage.refFromURL(url).delete();
      await ref.update({ images: imgs });
      renderImageGallery();
    }

    document.getElementById('uploadButton').addEventListener('click', () =>
      document.getElementById('imageUpload').click()
    );

    document.getElementById('imageUpload').addEventListener('change', async function(e) {
      if (!currentFolderId) return alert('Bitte Ordner auswählen!');
      for (const file of Array.from(e.target.files)) {
        try {
          const safe = file.name.replace(/[^a-z0-9_.-]/gi,'_');
          const ref = storage.ref(`projects/${currentFolderId}/${Date.now()}_${safe}`);
          await ref.put(file);
          const url = await ref.getDownloadURL();
          await db.collection('projects').doc(currentFolderId)
            .update({ images: firebase.firestore.FieldValue.arrayUnion(url) });
        } catch(err) {
          console.error('Upload Fehler:', err);
          alert(`Fehler bei ${file.name}: ${err.message}`);
        }
      }
      this.value = '';
      renderImageGallery();
    });

    document.getElementById('editButton').addEventListener('click', () => {
      editMode = !editMode;
      document.body.classList.toggle('edit-mode', editMode);
      document.getElementById('editButton').textContent = editMode?'Speichern':'Edit';
      document.getElementById('addProject').style.display = editMode?'block':'none';
      document.getElementById('uploadButton').style.display = editMode?'block':'none';
    });

    document.getElementById('addProject').addEventListener('click', async () => {
      const name = prompt('Ordnername:');
      const pin = prompt('PIN (optional):');
      if (!name) return;
      try {
        await db.collection('projects').add({
          name: name.trim(),
          pin: pin||null,
          parentId: currentFolderId,
          images: [],
          favorites: [],
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastModified: firebase.firestore.FieldValue.serverTimestamp()
        });
        initFirestoreListener();
      } catch(err) {
        alert('Fehler: '+err.message);
      }
    });

    // Neue, robuste Download‑Funktion
    async function downloadAllFavorites() {
      if (!favorites.length) {
        return alert('Keine favorisierten Bilder vorhanden!');
      }
      const zip = new JSZip();
      const fld = zip.folder("favorites");
      // XHR‑Blobs holen (besser als fetch bei CORS)
      function fetchBlob(url) {
        return new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', url);
          xhr.responseType = 'blob';
          xhr.onload = () => xhr.status===200 ? res(xhr.response) : rej(xhr.status);
          xhr.onerror = () => rej('Netzwerkfehler');
          xhr.send();
        });
      }
      for (const url of favorites) {
        try {
          const blob = await fetchBlob(url);
          const name = url.split('/').pop().split('?')[0];
          fld.file(name, blob);
        } catch(err) {
          console.error('Fehler beim Laden von', url, err);
        }
      }
      try {
        const content = await zip.generateAsync({ type: "blob" });
        saveAs(content, "favorites.zip");
      } catch(err) {
        console.error('ZIP-Fehler:', err);
        alert('Fehler beim Erstellen der ZIP-Datei!');
      }
    }
    document.getElementById('downloadFavorites')
      .addEventListener('click', downloadAllFavorites);

    function showFolderView() {
      document.getElementById('folderView').style.display = 'block';
      document.getElementById('imageView').style.display = 'none';
      document.getElementById('pinView').style.display = 'none';
      document.getElementById('downloadFavorites').style.display = 'none';
      initFirestoreListener();
    }
    function showImageView() {
      document.getElementById('folderView').style.display = 'none';
      document.getElementById('imageView').style.display = 'block';
      document.getElementById('pinView').style.display = 'none';
      document.getElementById('downloadFavorites').style.display =
        favorites.length ? 'block' : 'none';
    }

    updateBreadcrumb();
    initFirestoreListener();
    showFolderView();
  </script>
</body>
</html>
